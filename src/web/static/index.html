<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Proctoring Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Using Inter font for premium look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <header>
                <h1>AI Proctor</h1>
                <h2>Control Panel</h2>
            </header>

            <h3>Analysis Modules</h3>
            <div class="control-group">
                <div class="toggle-item">
                    <span class="toggle-label">Gaze Tracking</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-gaze" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span class="toggle-label">Face Movement</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-face-move" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span class="toggle-label">Face Detection</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-face-detect" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span class="toggle-label">Mouth Activity</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-mouth">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span class="toggle-label">Face Mesh</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-face-mesh" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-item">
                    <span class="toggle-label">Allowed Persons</span>
                    <div class="counter-control">
                        <button class="counter-btn" id="person-dec">-</button>
                        <span class="counter-value" id="person-count">1</span>
                        <button class="counter-btn" id="person-inc">+</button>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="start-btn">Start Session</button>
                <button id="stop-btn" class="secondary">End Session</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="video-wrapper">
                <img src="/video_feed" alt="Live Video Feed" id="video-feed">
                <div class="overlay">
                    <span class="status-badge">LIVE</span>
                </div>
            </div>
            
            <!-- Gaze Statistics Panel -->
            <div class="stats-panel" id="stats-panel">
                <h3>Gaze Tracking Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Status</span>
                        <span class="stat-value" id="stat-status">Looking at screen</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Attention</span>
                        <span class="stat-value" id="stat-attention">100%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Violations</span>
                        <span class="stat-value" id="stat-violations">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Away Time</span>
                        <span class="stat-value" id="stat-away-time">0.0s</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Session Duration</span>
                        <span class="stat-value" id="stat-session-duration">0.0s</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg Violation</span>
                        <span class="stat-value" id="stat-avg-violation">0.0s</span>
                    </div>
                </div>
                <button id="reset-stats-btn" class="secondary">Reset Statistics</button>
            </div>
        </main>
    </div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const videoFeed = document.getElementById('video-feed');

        // Toggles
        const toggles = [
            'toggle-gaze', 'toggle-face-move', 'toggle-face-detect', 
            'toggle-mouth'
        ];

        toggles.forEach(id => {
            const toggle = document.getElementById(id);
            toggle.addEventListener('change', (e) => {
                console.log(`${id} changed to ${e.target.checked}`);
                // Future: Send configuration to backend
            });
        });

        // Face Mesh Toggle (with backend integration)
        const faceMeshToggle = document.getElementById('toggle-face-mesh');
        faceMeshToggle.addEventListener('change', async (e) => {
            const enabled = e.target.checked;
            console.log(`Face mesh ${enabled ? 'enabled' : 'disabled'}`);
            
            try {
                const response = await fetch(`/toggle_face_mesh?enabled=${enabled}`, {
                    method: 'POST'
                });
                const data = await response.json();
                console.log('Face mesh status:', data);
            } catch (error) {
                console.error('Error toggling face mesh:', error);
            }
        });

        // Person Counter
        const personCountSpan = document.getElementById('person-count');
        const personIncBtn = document.getElementById('person-inc');
        const personDecBtn = document.getElementById('person-dec');
        let personCount = 1;

        personIncBtn.addEventListener('click', () => {
            personCount++;
            personCountSpan.textContent = personCount;
            console.log(`Allowed persons set to ${personCount}`);
        });

        personDecBtn.addEventListener('click', () => {
            if (personCount > 1) {
                personCount--;
                personCountSpan.textContent = personCount;
                console.log(`Allowed persons set to ${personCount}`);
            }
        });

        // Gaze Tracking Toggle
        const gazeToggle = document.getElementById('toggle-gaze');
        gazeToggle.addEventListener('change', async (e) => {
            const enabled = e.target.checked;
            console.log(`Gaze tracking ${enabled ? 'enabled' : 'disabled'}`);
            
            try {
                const response = await fetch(`/toggle_gaze_tracking?enabled=${enabled}`, {
                    method: 'POST'
                });
                const data = await response.json();
                console.log('Gaze tracking status:', data);
                
                // Show/hide stats panel
                const statsPanel = document.getElementById('stats-panel');
                if (enabled) {
                    statsPanel.style.display = 'block';
                    startStatsUpdate();
                } else {
                    statsPanel.style.display = 'none';
                    stopStatsUpdate();
                }
            } catch (error) {
                console.error('Error toggling gaze tracking:', error);
            }
        });

        // Statistics Update
        let statsInterval = null;

        function startStatsUpdate() {
            if (statsInterval) return;
            
            statsInterval = setInterval(async () => {
                try {
                    const response = await fetch('/gaze_statistics');
                    const stats = await response.json();
                    
                    // Update UI
                    document.getElementById('stat-status').textContent = 
                        stats.is_currently_looking_away ? 'Looking away' : 'Looking at screen';
                    document.getElementById('stat-status').style.color = 
                        stats.is_currently_looking_away ? '#ef4444' : '#10b981';
                    
                    document.getElementById('stat-attention').textContent = 
                        `${stats.attention_percentage.toFixed(1)}%`;
                    document.getElementById('stat-violations').textContent = 
                        stats.total_violations;
                    document.getElementById('stat-away-time').textContent = 
                        `${stats.total_looking_away_time.toFixed(1)}s`;
                    document.getElementById('stat-session-duration').textContent = 
                        `${stats.session_duration.toFixed(1)}s`;
                    document.getElementById('stat-avg-violation').textContent = 
                        `${stats.average_violation_duration.toFixed(1)}s`;
                } catch (error) {
                    console.error('Error fetching statistics:', error);
                }
            }, 500); // Update every 500ms
        }

        function stopStatsUpdate() {
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
        }

        // Reset Statistics Button
        const resetStatsBtn = document.getElementById('reset-stats-btn');
        resetStatsBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/reset_gaze_statistics', {
                    method: 'POST'
                });
                const data = await response.json();
                console.log('Statistics reset:', data);
            } catch (error) {
                console.error('Error resetting statistics:', error);
            }
        });

        startBtn.addEventListener('click', () => {
            console.log('Session started');
            videoFeed.src = "/video_feed?" + new Date().getTime();
            startBtn.textContent = "Session Active";
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            // Start stats update if gaze tracking is enabled
            if (gazeToggle.checked) {
                startStatsUpdate();
            }
        });

        stopBtn.addEventListener('click', () => {
            console.log('Session ended');
            videoFeed.src = ""; // Or placeholder
            startBtn.textContent = "Start Session";
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            // Stop stats update
            stopStatsUpdate();
        });

        // Auto-load video feed on page load
        window.addEventListener('load', () => {
            videoFeed.src = "/video_feed?" + new Date().getTime();
            
            // Start stats update if gaze tracking is enabled
            if (gazeToggle.checked) {
                startStatsUpdate();
            }
        });
    </script>
</body>
</html>
